<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>今日待办 - 仿苹果风</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="common.css">
    <style>
        .todo-list {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .todo-header {
            padding: 16px;
            border-bottom: 1px solid #f5f5f7;
        }

        .todo-title {
            font-size: 16px;
            font-weight: 500;
            color: #6e6e73;
            margin: 0;
        }

        .todo-item {
            padding: 16px;
            border-bottom: 1px solid #f5f5f7;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
            position: relative;
        }

        .todo-item:last-child {
            border-bottom: none;
        }

        .todo-item:hover {
            background-color: #fafafa;
        }

        .todo-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }

        .todo-item.over {
            background-color: #f5f5f7;
        }

        .todo-index {
            width: 24px;
            text-align: center;
            color: #6e6e73;
            font-size: 14px;
        }

        .todo-content {
            flex-grow: 1;
        }

        .todo-name {
            font-size: 16px;
            font-weight: 400;
            margin: 0;
        }

        .todo-completed .todo-name {
            text-decoration: line-through;
            color: #6e6e73;
        }

        .todo-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 移动端适配 */
        @media (max-width: 600px) {
            .todo-item {
                padding: 12px;
                gap: 12px;
            }

            .todo-index {
                width: 20px;
            }
        }

        .pomodoro {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
        }

        .pomodoro.completed {
            background-color: #007aff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">今日待办</h1>
            <p class="subtitle">管理你的任务和番茄钟</p>
        </div>

        <div class="input-container">
            <div class="form-group" >
                <div class="form-control">
                    <label for="taskInput" class="form-label">任务名称</label>
                    <input type="text" id="taskInput" placeholder="输入任务名称（最多15字）" maxlength="15"
                           class="form-input" onkeydown="handleEnter(event)">
                </div>

                <div class="form-control">
                    <label for="pomodoroInput" class="form-label">番茄数量</label>
                    <input type="number" id="pomodoroInput" min="0" max="9" placeholder="可用番茄（0~9）"
                           class="form-input" onkeydown="handleEnter(event)">
                </div>

                <button class="btn btn-primary" onclick="addTask()" style="width: 100%;margin-top: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    添加任务
                </button>
            </div>
        </div>

        <div class="todo-list">
            <div class="todo-header">
                <h2 class="todo-title">待办事项</h2>
            </div>
            <div id="todoItems">
                <!-- 动态添加的任务将插入到这里 -->
            </div>
        </div>
    </div>

    <script>
        const taskInput = document.getElementById('taskInput');
        const pomodoroInput = document.getElementById('pomodoroInput');
        const todoItems = document.getElementById('todoItems');

        function addTask() {
            const taskName = taskInput.value.trim();
            const pomodoroCount = parseInt(pomodoroInput.value) || 0;

            if (taskName === '') return;

            let rowNumber = todoItems.children.length + 1;

            // 创建任务项元素
            const taskItem = document.createElement('div');
            taskItem.className = 'todo-item fade-in';
            taskItem.setAttribute("draggable", "true");
            taskItem.setAttribute("data-id", Date.now()); // 使用时间戳作为唯一ID

            // 序号
            const indexElement = document.createElement('div');
            indexElement.className = 'todo-index';
            indexElement.textContent = rowNumber;

            // 任务内容
            const contentElement = document.createElement('div');
            contentElement.className = 'todo-content';

            const nameElement = document.createElement('h3');
            nameElement.className = 'todo-name';
            nameElement.textContent = taskName;

            contentElement.appendChild(nameElement);

            // 番茄计数和删除按钮
            const controlsElement = document.createElement('div');
            controlsElement.className = 'todo-controls';

            const pomodoroContainer = document.createElement('div');
            pomodoroContainer.className = 'pomodoro-container';

            if (pomodoroCount === 0) {
                const noPomodoroText = document.createElement('span');
                noPomodoroText.className = 'no-pomodoros';
                noPomodoroText.textContent = '0';
                pomodoroContainer.appendChild(noPomodoroText);
            } else {
                for (let i = 0; i < pomodoroCount; i++) {
                    const pomodoro = document.createElement('div');
                    pomodoro.className = 'pomodoro';
                    pomodoro.setAttribute('data-index', i);
                    pomodoro.onclick = function() { togglePomodoro(pomodoro, taskItem); };
                    pomodoroContainer.appendChild(pomodoro);
                }
            }

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn-delete';
            deleteButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
            deleteButton.onclick = function() { removeTask(taskItem); };

            controlsElement.appendChild(pomodoroContainer);
            controlsElement.appendChild(deleteButton);

            // 组装任务项
            taskItem.appendChild(indexElement);
            taskItem.appendChild(contentElement);
            taskItem.appendChild(controlsElement);

            // 添加到列表
            todoItems.appendChild(taskItem);

            // 初始化拖放事件
            addDragAndDropEvents(taskItem);

            // 清空输入框
            taskInput.value = '';
            pomodoroInput.value = '';

            // 聚焦到任务输入框
            taskInput.focus();
        }

        function removeTask(taskItem) {
            // 添加淡出动画
            taskItem.style.transition = 'all 0.3s ease';
            taskItem.style.opacity = '0';
            taskItem.style.transform = 'translateX(20px)';

            // 动画结束后移除元素
            setTimeout(() => {
                taskItem.remove();
                updateRowNumbers();
            }, 300);
        }

        function updateRowNumbers() {
            const items = document.querySelectorAll('.todo-item');
            items.forEach((item, index) => {
                item.querySelector('.todo-index').textContent = index + 1;
            });
        }

        function togglePomodoro(pomodoro, taskItem) {
            const pomodoros = Array.from(taskItem.querySelectorAll('.pomodoro'));
            const index = parseInt(pomodoro.getAttribute('data-index'));

            // 检查当前状态
            const isCompleted = pomodoro.classList.contains('completed');

            if (isCompleted) {
                // 从后往前取消勾选
                for (let i = pomodoros.length - 1; i >= index; i--) {
                    pomodoros[i].classList.remove('completed');
                }
            } else {
                // 从前往后勾选
                for (let i = 0; i <= index; i++) {
                    pomodoros[i].classList.add('completed');
                }
            }
        }

        function addDragAndDropEvents(item) {
            item.addEventListener("dragstart", function(e) {
                item.classList.add("dragging");
                e.dataTransfer.setData("text/plain", null); // 必要的 hack 来启用拖拽
                window.draggedItem = item;
            });

            item.addEventListener("dragend", function() {
                item.classList.remove("dragging");
                window.draggedItem = null;
            });

            item.addEventListener("dragover", function(e) {
                e.preventDefault();
                if (this !== window.draggedItem) {
                    this.classList.add("over");
                }
            });

            item.addEventListener("dragleave", function() {
                this.classList.remove("over");
            });

            item.addEventListener("drop", function(e) {
                e.preventDefault();
                if (this !== window.draggedItem && this.tagName === "DIV") {
                    const itemsContainer = this.parentNode;
                    const isAfter = Array.from(itemsContainer.children).indexOf(this) >
                                    Array.from(itemsContainer.children).indexOf(window.draggedItem);

                    if (isAfter) {
                        itemsContainer.insertBefore(window.draggedItem, this.nextSibling);
                    } else {
                        itemsContainer.insertBefore(window.draggedItem, this);
                    }

                    updateRowNumbers();
                }
                this.classList.remove("over");
            });
        }

        function handleEnter(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        }
    </script>
</body>
</html>